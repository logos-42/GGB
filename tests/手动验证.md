# 设备检测功能手动验证指南

## 修复完成 ✅

所有修复已完成，包括：

1. **内存计算错误修复** - 从字节正确转换为MB
2. **GPU检测增强** - 完整支持NVIDIA/AMD/Intel GPU
3. **移除硬编码** - 使用真实测量值
4. **添加验证工具** - `src/bin/verify_detection.rs`

## 测试方法

### 方法1: 快速验证（推荐）

```powershell
# 在PowerShell中运行
. "快速测试设备检测.ps1"
```

### 方法2: 手动编译和运行

```bash
# 1. 编译验证程序
cargo build --release --bin verify_detection

# 2. 运行检测
target\release\verify_detection.exe

# 3. 运行单元测试
cargo test --test device_detection_test -- --nocapture
```

### 方法3: 运行批处理脚本

双击运行: `run_device_test.bat`

## 验证要点

### ✅ 正确结果应该显示：

1. **内存**: 显示真实内存（如16384 MB = 16GB）
   - 不应是2048/4096/8192等常见默认值
   - 可通过 `systeminfo | findstr "物理内存"` 手动验证

2. **CPU核心**: 显示真实核心数
   - 可通过 `wmic cpu get NumberOfCores` 手动验证

3. **GPU**: 
   - NVIDIA GPU应显示CUDA/Vulkan/OpenCL
   - AMD GPU应显示Vulkan/OpenCL
   - Intel GPU应显示DirectX/Vulkan/OpenCL
   - 可通过 `wmic path win32_VideoController get name` 手动验证

4. **无硬编码值**: 
   - 不应显示 "RTX 3060"、30.5%、8.0GB、2.3GB 等模拟值

### ❌ 如果仍然有问题：

1. **检查依赖**: 确保 `sysinfo = "0.37.2"` 已安装
2. **管理员权限**: GPU检测可能需要管理员权限
3. **驱动安装**: AMD/Intel GPU需要正确安装驱动

## 预期输出示例

```
========================================
设备检测功能验证
========================================

📊 检测到的设备信息:
   内存: 16384 MB (16.0 GB)  ← 真实值，不是硬编码
   CPU核心: 16                ← 真实核心数
   架构: x86_64 (AMD Ryzen...)
   设备类型: Desktop

🔋 电池信息:
   无电池（可能是台式机）

🎮 GPU信息:
   GPU状态: 支持
   支持的API: 3 个
     1. CUDA
     2. Vulkan
     3. OpenCL

   详细GPU信息:
   GPU 1:
     名称: NVIDIA GeForce RTX 4060
     使用率: 15%              ← 真实测量值
     显存使用: 2048 MB
     显存总量: 8182 MB
     温度: 55°C

📡 网络类型: WiFi

🏆 性能评分: 0.85/1.00
```

## 常见硬编码值（已移除）

修复前可能显示：
- `gpu_type = "NVIDIA GeForce RTX 3060"` ← 已替换为真实检测
- `gpu_usage = 30.5` ← 已替换为真实测量
- `gpu_memory_total = 8.0 GB` ← 已替换为真实测量
- `gpu_memory_used = 2.3 GB` ← 已替换为真实测量
- `max_memory_mb = 8192` ← 已替换为sysinfo真实值

## 测试文件位置

- 验证程序: `src/bin/verify_detection.rs`
- 单元测试: `tests/device_detection_test.rs`
- PowerShell脚本: `快速测试设备检测.ps1`
- 批处理脚本: `run_device_test.bat`

## 故障排除

### 如果编译失败：

```bash
# 清理并重新编译
cargo clean
cargo build --release --bin verify_detection
```

### 如果检测结果不准确：

1. 检查 `sysinfo` 版本是否为 `0.37.2`
2. 以管理员身份运行PowerShell
3. 检查GPU驱动是否安装正确
4. 查看 `src/device/platform/windows.rs` 中的检测逻辑

### 如果GPU检测不到：

```powershell
# 手动验证系统命令
wmic path win32_VideoController get name
nvidia-smi  # 如果有NVIDIA GPU
```
