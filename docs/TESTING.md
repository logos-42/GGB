# 测试指南

## 概述

本文档介绍如何测试 GGS 去中心化训练系统的各项功能。

## 快速开始

### 单节点测试

最简单的测试方式是启动单个节点：

```bash
cargo run
```

节点会自动：
- 检测设备能力
- 连接到 P2P 网络
- 开始训练和同步

### 多节点测试

使用提供的测试脚本启动多个节点：

**Windows (PowerShell):**
```powershell
.\scripts\test_multi_node.ps1 -Nodes 3 -Duration 300
```

**Linux/Mac:**
```bash
bash scripts/test_multi_node.sh --nodes 3 --duration 300
```

参数说明：
- `--nodes`: 节点数量（默认 3）
- `--duration`: 训练持续时间，秒（默认 300）
- `--model-dim`: 模型维度（默认 256）
- `--output-dir`: 输出目录（默认 test_output）

## 测试场景

### 1. 节点发现测试

验证节点能否自动发现彼此：

1. 在同一网络启动 2-3 个节点
2. 观察日志中的 "通过 mDNS 发现节点" 消息
3. 验证拓扑更新消息

**预期结果：**
- 节点应在 10-30 秒内发现彼此
- 每个节点应建立 4-8 个邻居连接

### 2. 模型同步测试

验证模型参数是否在节点间同步：

1. 启动多个节点
2. 运行 5-10 分钟
3. 检查模型 hash 是否收敛

**预期结果：**
- 模型 hash 应逐渐稳定
- 收敛度指标应逐渐增加（接近 1.0）
- 参数变化幅度应逐渐减小

### 3. 网络自适应测试

验证网络类型切换时的行为：

1. 启动节点（初始在 WiFi 环境）
2. 切换到移动网络（或模拟）
3. 观察带宽调整和传输策略变化

**预期结果：**
- WiFi 下允许密集快照
- 移动网络下仅稀疏更新
- 带宽预算自动调整

### 4. 电池感知测试

验证电池状态对训练的影响：

```bash
# 模拟低电量
export GGS_BATTERY_LEVEL=0.15
export GGS_BATTERY_CHARGING=false
cargo run
```

**预期结果：**
- 训练频率应降低（30-60 秒）
- 电量低于 10% 时应暂停训练

### 5. 资源管理测试

验证内存压力下的行为：

1. 使用低内存设备配置
2. 观察 Top-K 值是否自动减少
3. 检查内存使用是否在限制内

**预期结果：**
- 内存压力时 Top-K 自动减半
- 内存使用不超过阈值

## 分析测试结果

使用分析工具处理测试结果：

```bash
cargo run --bin analyze_training -- --input test_output
```

这将生成 `training_report.json`，包含：
- 每个节点的详细统计
- 总体训练摘要
- 交互次数和模型版本

## 性能基准

### 预期性能指标

- **节点发现时间**: < 30 秒
- **消息延迟**: < 100ms（本地网络）
- **模型同步频率**: 每 10 秒一次心跳，每 2 分钟一次密集快照
- **内存使用**: < 512MB（256 维模型）
- **CPU 使用**: < 10%（空闲时）

### 压力测试

测试系统在极限条件下的表现：

```bash
# 启动 10 个节点
.\scripts\test_multi_node.ps1 -Nodes 10 -Duration 600
```

观察：
- 网络带宽使用
- 内存占用
- CPU 使用率
- 消息丢失率

## 移动端测试

### Android 测试

1. 构建 Android 库：
   ```bash
   cargo build --target aarch64-linux-android --release
   ```

2. 在 Android Studio 中集成
3. 在真实设备上运行
4. 验证设备能力检测

### iOS 测试

1. 构建 iOS 库：
   ```bash
   cargo build --target aarch64-apple-ios --release
   ```

2. 在 Xcode 中集成
3. 在真实设备或模拟器上运行
4. 验证网络和电池检测

## 故障排查

### 节点无法发现彼此

- 检查防火墙设置
- 确认在同一网络
- 检查 mDNS 是否启用
- 查看日志中的错误信息

### 模型不同步

- 检查网络连接
- 验证签名是否正确
- 查看拓扑健康状态
- 检查带宽限制

### 内存不足

- 降低模型维度
- 减少邻居数量
- 启用内存压力检测

## 持续集成

建议的 CI 测试流程：

1. 单元测试：`cargo test`
2. 集成测试：`cargo test --test integration_test`
3. 代码检查：`cargo clippy`
4. 格式化检查：`cargo fmt --check`

## 下一步

- 添加性能基准测试
- 实现自动化测试套件
- 添加压力测试场景
- 创建可视化测试工具

